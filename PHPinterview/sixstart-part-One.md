# 六星-Part-One

感谢六星教育老师们每天的分享。来源：PHP开源社区

文档根据每天群内讨论问题整理。

### 2019-8-21

#### 分库分表技术方面考虑，什么时候该分库分表，怎么操作？

##### 1：为什么Redis需要把所有数据放到内存中？

Redis为了达到最快的读写速度将数据都读到内存中，并通过异步的方式将数据写入磁盘。
所以redis具有快速和数据持久化的特征。如果不将数据放在内存中，磁盘I/O速度为严重影响redis的性能。
在内存越来越便宜的今天，redis将会越来越受欢迎。 如果设置了最大使用的内存，则数据已有记录数达到内存限值后不能继续插入新值。

##### 2：分库分表技术方面考虑，什么时候该分库分表，怎么操作？

垂直分表，把不常用的字段拆分到另外一张表。
垂直分库，把不同业务的数据放在不同的库。服务化的拆分利于解耦和提高性能，也利于系统扩展。
水平分表，表中的数据（比如user表）按照一定规律（比如对id进行hash和取模后拆分）。可以一定程度缓解查询性能瓶颈。但还会有库级别IO瓶颈，因为数据在同一个库中。

水平分库分表，于水平分表类似，唯一不同是将这些拆分出来的表保存在不同的数据库中。在冷热数据分离的场景很适用。能有效缓解单机和单裤性能瓶颈压力，突破IO、连接数、硬件资源的瓶颈。

### 2019-8-22

#### Redis 集群方案怎么做？都有哪些方案？

##### 一、Redis有哪几种数据淘汰策略？

noeviction:返回错误当内存限制达到并且客户端尝试执行会让更多内存被使用的命令（大部分的写入指令，但DEL和几个例外）

allkeys-lru: 尝试回收最少使用的键（LRU），使得新添加的数据有空间存放。

volatile-lru: 尝试回收最少使用的键（LRU），但仅限于在过期集合的键，使得新添加的数据有空间存放。

allkeys-random: 回收随机的键使得新添加的数据有空间存放。

volatile-random: 回收随机的键使得新添加的数据有空间存放，但仅限于在过期集合的键。

volatile-ttl: 回收在过期集合的键，并且优先回收存活时间（TTL）较短的键，使得新添加的数据有空间存放。

##### 二、Redis集群方案应该怎么做？都有哪些方案？

1. `codis`。目前用的最多的集群方案，基本和`twemproxy`一致的效果，但它支持在 节点数量改变情况下，旧节点数据可恢复到新hash节点。

2. redis cluster3.0自带的集群，特点在于他的分布式算法不是一致性hash，而是hash槽的概念，以及自身支持节点设置从节点。具体看官方文档介绍。

3. 在业务代码层实现，起几个毫无关联的redis实例，在代码层，对key 进行hash计算，然后去对应的redis实例操作数据。 这种方式对hash层代码要求比较高，考虑部分包括，节点失效后的替代算法方案，数据震荡后的自动脚本恢复，实例的监控，等等。

P.S. 

`twemproxy`: 一种代理分片机制，由 `Twitter`开源。

`codis`: 一种分布式 `Redis` 解决方案

![codis](assets\images\codis.png "codis:图片源百度百科")


